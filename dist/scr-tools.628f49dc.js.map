{"version":3,"sources":["lib/dnd.js","scr-tools/lib/zx-colour.js","scr-tools/lib/Zoom.js","scr-tools/lib/scr.js","lib/$.js","lib/save.js","scr-tools/lib/matrices.js","scr-tools/lib/Dither.js","scr-tools/lib/image.js","scr-tools/lib/retrofy.js","scr-tools/index.js","../node_modules/parcel-bundler/src/builtins/hmr-runtime.js"],"names":["drop","root","callback","ondragover","ondragend","ondrop","e","preventDefault","droppedFile","dataTransfer","files","reader","FileReader","onload","event","Uint8Array","target","result","readAsArrayBuffer","brightColoursLookup","Map","set","toString","normalColoursLookup","brightColours","normalColours","getIndexForXY","width","x","y","order","Zoom","constructor","buffer","document","body","id","HTMLImageElement","img","canvas","createElement","appendChild","height","ctx","getContext","drawImage","parentNode","replaceChild","CanvasRenderingContext2D","sourceCtx","getImageData","data","toBlob","blob","url","URL","createObjectURL","style","background","clearRect","ImageData","isVisible","_last","makeVisible","className","scale","w","h","imageRendering","setProperty","put","imageData","putImageData","seeXY","key","pixel","strokeStyle","strokeRect","sourceWidth","source","Uint8ClampedArray","print","i","j","index","end","offset","console","log","subarray","slice","toBlink","blinkOn","block","attribute","start","pixels","ink","paper","readAttributes","ptr","byte","colour","load","fetch","arrayBuffer","sleep","ms","Promise","resolve","setTimeout","draw","third","ctr","line","bit","stream","attribs","type","blink","push","pixelsForSCR","loadBlinkAttributes","join","timer","setInterval","doBlink","stop","clearInterval","length","forEach","item","main","zoom","window","fillStyle","fillRect","onmousemove","bright","readFromPoint","pageX","pageY","innerHTML","padStart","onclick","values","pixelsToBytes","canvasImageData","row","putPixels","allPixels","allData","getInkFromPixel","rgb","shiftBright","get","attributesForBlock","inks","fill","Object","keys","count","Array","from","map","filter","sort","a","b","putAttributes","inkData","download","filename","click","node","MouseEvent","dispatchEvent","Blob","href","revokeObjectURL","ArrayNode","Proxy","obj","prop","value","HTMLElement","prototype","el","res","on","handler","options","addEventListener","emit","Event","$","s","querySelectorAll","fileName","isArray","oneDimensional","factor","floydSteinberg","jarvisJudiceNinke","stucki","atkinson","burkes","sierra3","sierra2","sierraLite","none","colorMap","getDistance","current","match","redDifference","greenDifference","blueDifference","defaultFindColor","shortestDistance","Number","MAX_SAFE_INTEGER","distance","defaults","step","channels","diffusionFactor","clip","findColor","matrix","matrices","Dither","dither","settings","k","ref","d","handlePixel","calculateIndex","currentColor","l","newColor","q","ref1","diffuseError","applyNewColor","channelOffset","entry","len","results","di","dx","dy","results1","m","ref2","results2","image","imageToBlob","then","fileToBinary","contrast","intercept","threshold","_","r","g","test","v","invertPotentialInk","inkCount","c","crop","destination","longest","shortest","imageToCanvas","imageToPixels","file","onloadend","all","debug","Image","crossOrigin","src","reject","onerror","bufferCtx","render","pixelData","renderFromInk","originalData","pixelsToImage","toDataURL","prompt","scrBlob","scrURL","container","scrCtx","ul","li","attribsLI","img2","inkImg","pixelImg","zoomOriginal","zoomPixel","zoomInk","zoomResult","rootCanvas","querySelector","classList","add","hover","bind","putInkForBlock","newBlock","attributes","blockBuffer","location","search","includes","basename","split","altDownload","isSCR","toUpperCase","endsWith","div","button","innerText","prepend","fileHandler","name","OVERLAY_ID","OldModule","module","bundle","Module","moduleName","call","hot","hotData","_acceptCallbacks","_disposeCallbacks","accept","fn","dispose","checkedAssets","assetsToAccept","parent","isParcelRequire","WebSocket","hostname","protocol","ws","onmessage","JSON","parse","handled","assets","asset","isNew","didAccept","hmrAcceptCheck","global","parcelRequire","every","generated","js","clear","hmrApply","hmrAcceptRun","reload","close","onclose","removeErrorOverlay","error","message","stack","overlay","createErrorOverlay","getElementById","remove","stackTrace","getParents","modules","parents","dep","concat","Function","deps","cached","cache","some","cb"],"mappings":"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","file":"scr-tools.628f49dc.js","sourceRoot":"../public","sourcesContent":["export default function drop(root, callback) {\n  root.ondragover = () => false;\n  root.ondragend = () => false;\n  root.ondrop = e => {\n    e.preventDefault();\n\n    const droppedFile = e.dataTransfer.files[0];\n    const reader = new FileReader();\n    reader.onload = event => {\n      callback(new Uint8Array(event.target.result));\n    };\n    reader.readAsArrayBuffer(droppedFile);\n\n    return false;\n  };\n}\n","export const brightColoursLookup = new Map();\nbrightColoursLookup.set([0, 0, 0].toString(), 0b000);\nbrightColoursLookup.set([0, 0, 0xff].toString(), 0b001);\nbrightColoursLookup.set([0xff, 0, 0].toString(), 0b010);\nbrightColoursLookup.set([0xff, 0, 0xff].toString(), 0b011);\nbrightColoursLookup.set([0, 0xff, 0].toString(), 0b100);\nbrightColoursLookup.set([0, 0xff, 0xff].toString(), 0b101);\nbrightColoursLookup.set([0xff, 0xff, 0].toString(), 0b110);\nbrightColoursLookup.set([0xff, 0xff, 0xff].toString(), 0b111);\n\nexport const normalColoursLookup = new Map();\nnormalColoursLookup.set([0, 0, 0].toString(), 0b000);\nnormalColoursLookup.set([0, 0, 0xd7].toString(), 0b001);\nnormalColoursLookup.set([0xd7, 0, 0].toString(), 0b010);\nnormalColoursLookup.set([0xd7, 0, 0xd7].toString(), 0b011);\nnormalColoursLookup.set([0, 0xd7, 0].toString(), 0b100);\nnormalColoursLookup.set([0, 0xd7, 0xd7].toString(), 0b101);\nnormalColoursLookup.set([0xd7, 0xd7, 0].toString(), 0b110);\nnormalColoursLookup.set([0xd7, 0xd7, 0xd7].toString(), 0b111);\n\nexport const brightColours = {\n  0b000: [0, 0, 0],\n  0b001: [0, 0, 0xff],\n  0b010: [0xff, 0, 0],\n  0b011: [0xff, 0, 0xff],\n  0b100: [0, 0xff, 0],\n  0b101: [0, 0xff, 0xff],\n  0b110: [0xff, 0xff, 0],\n  0b111: [0xff, 0xff, 0xff],\n};\n\nexport const normalColours = {\n  0b000: [0, 0, 0],\n  0b001: [0, 0, 0xd7],\n  0b010: [0xd7, 0, 0],\n  0b011: [0xd7, 0, 0xd7],\n  0b100: [0, 0xd7, 0],\n  0b101: [0, 0xd7, 0xd7],\n  0b110: [0xd7, 0xd7, 0],\n  0b111: [0xd7, 0xd7, 0xd7],\n};\n","function getIndexForXY(width, x, y) {\n  return width * y + x;\n}\n\nlet order = 1;\n\nexport default class Zoom {\n  constructor(buffer, target = document.body, id) {\n    this.target = target;\n    this.order = order++;\n    this.id = id || `zoom-${this.order}`;\n    if (buffer instanceof HTMLImageElement) {\n      const img = buffer;\n      const canvas = document.createElement('canvas');\n      target.appendChild(canvas);\n      canvas.width = img.width;\n      canvas.height = img.height;\n      const ctx = (buffer = canvas.getContext('2d'));\n      ctx.drawImage(img, 0, 0);\n      img.parentNode.replaceChild(canvas, img);\n    }\n\n    if (buffer instanceof CanvasRenderingContext2D) {\n      const ctx = (this.sourceCtx = buffer);\n      this.buffer = buffer.getImageData(\n        0,\n        0,\n        buffer.canvas.width,\n        buffer.canvas.height\n      ).data;\n      ctx.canvas.toBlob(blob => {\n        const url = URL.createObjectURL(blob);\n        ctx.canvas.style.background = `url(${url}) no-repeat`;\n        ctx.clearRect(0, 0, buffer.canvas.width, buffer.canvas.height);\n      });\n    } else {\n      this.buffer = buffer instanceof ImageData ? buffer.data : buffer;\n    }\n    this.isVisible = false;\n    this._last = null;\n  }\n\n  makeVisible(target = this.target) {\n    const canvas = document.createElement('canvas');\n    canvas.className = 'zoom';\n    canvas.id = this.id;\n    target.appendChild(canvas);\n    this.ctx = canvas.getContext('2d');\n\n    const scale = 20;\n    const w = (canvas.width = 8);\n    const h = (canvas.height = 8);\n    canvas.style.imageRendering = 'pixelated';\n    canvas.style.width = `${w * scale}px`;\n    canvas.style.height = `${h * scale}px`;\n    canvas.style.setProperty('--order', this.order);\n    this.isVisible = true;\n\n    return this;\n  }\n\n  put(imageData) {\n    const ctx = this.ctx;\n    ctx.putImageData(imageData, 0, 0);\n  }\n\n  seeXY(x, y) {\n    const key = `${x}x${y}`;\n    if (key === this._last) return;\n    this._last = key;\n    if (!this.isVisible) this.makeVisible();\n    const imageData = new ImageData(this.pixel(x, y), 8, 8);\n    this.ctx.putImageData(imageData, 0, 0);\n\n    if (this.sourceCtx) {\n      const ctx = this.sourceCtx;\n      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);\n      ctx.strokeStyle = 'white';\n      ctx.strokeRect(x * 8 + 0.5, y * 8 + 0.5, 8, 8);\n      ctx.strokeStyle = 'black';\n      ctx.strokeRect(x * 8 - 0.5, y * 8 - 0.5, 8, 8);\n    }\n  }\n\n  pixel(x = 0, y = 0) {\n    const sourceWidth = 256;\n    const width = 8;\n    const height = 8;\n    const source = this.buffer;\n\n    const data = new Uint8ClampedArray(width * height * 4);\n\n    const print = false; //x === 31 && y === 23;\n\n    for (let i = 0; i < height; i++) {\n      const j = getIndexForXY(sourceWidth, x * 8, y * 8 + i);\n      const index = j * 4;\n      const end = index + width * 4;\n      const offset = i * width * 4;\n      if (print) {\n        console.log(\n          'j: %s, index: %s, end: %s',\n          j,\n          index,\n          end,\n          x * 8,\n          i,\n          source.subarray(index, end)\n        );\n      }\n      data.set(source.slice(index, end), offset);\n    }\n\n    return data;\n  }\n}\n","import {\n  brightColours,\n  normalColours,\n  normalColoursLookup,\n  brightColoursLookup,\n} from './zx-colour.js';\n\nimport Zoom from './Zoom.js';\n\nlet toBlink = [];\nlet blinkOn = false;\n\nfunction block(\n  x = 0,\n  y = 0,\n  buffer, // expected to be 6912 long (2048 * 3 + 768)\n  attribute = buffer.subarray(2048 * 3)[y * 32 + x]\n) {\n  const start = ((y / 8) | 0) * 2048;\n  const pixels = buffer.subarray(start, start + 2048);\n\n  // reminder: paper is binary 0, ink is 1\n  const { ink, paper } = readAttributes(attribute);\n  const pixel = new Uint8ClampedArray(4 * 8 * 8);\n  y = y % 8;\n\n  for (let i = 0; i < 8; i++) {\n    const ptr = x + 256 * i + y * 32;\n    const byte = pixels[ptr];\n\n    // imageData rgba 8x1\n    for (let j = 0; j < 8; j++) {\n      // determines bit for i, based on MSb as left most pixel\n      const colour = (byte & (1 << (7 - j))) === 0 ? paper : ink;\n\n      const offset = j * 4 + 4 * 8 * i;\n      pixel[offset + 0] = colour[0];\n      pixel[offset + 1] = colour[1];\n      pixel[offset + 2] = colour[2];\n      pixel[offset + 3] = 255;\n    }\n  }\n\n  return pixel;\n}\n\nexport async function load(url) {\n  return new Uint8Array(await (await fetch(url)).arrayBuffer());\n}\n\nasync function sleep(ms) {\n  // return;\n  if (!ms) return;\n  return new Promise(resolve => setTimeout(() => resolve(), ms));\n}\n\nasync function put(ctx, imageData, x, y) {\n  ctx.putImageData(imageData, x, y);\n  await sleep(0);\n}\n\nasync function draw(ctx, third, data) {\n  const imageData = new Uint8ClampedArray(4 * 8);\n  let ctr = 0;\n  for (let offset = 0; offset < 8; offset++) {\n    for (let line = 0; line < 8; line++) {\n      for (let i = 0; i < 32; i++) {\n        let j = 0;\n        const ptr = ctr++;\n        const byte = data[ptr];\n\n        // imageData rgba 8x1\n        for (; j < 8; j++) {\n          // determines bit for i, based on MSb\n          const bit = (byte & (1 << (7 - j))) === 0 ? 0 : 255;\n\n          const offset = j * 4;\n          imageData[offset + 0] = bit;\n          imageData[offset + 1] = bit;\n          imageData[offset + 2] = bit;\n          imageData[offset + 3] = 255; // - bit; // alpha\n        }\n        const x = i * 8;\n        const y = (ctx.canvas.height / 3) * third + line * 8 + offset;\n        await put(ctx, new ImageData(imageData, 8, 1), x, y);\n      }\n    }\n  }\n}\n\n// stream individual whole bytes into the canvas\nexport async function stream(ctx, byte, index) {\n  const third = index >> 11; // 0..2047, 2048..4095, 4096..6143\n\n  if (third === 3) {\n    // colour\n    const attribs = readAttributes(byte);\n    const x = (index % 32) * 8;\n    const y = ((index >> 5) % 64) * 8;\n\n    const block = ctx.getImageData(x, y, 8, 8);\n    for (let i = 0; i < 8 * 8; i++) {\n      const type = block.data[i * 4] === 255 ? 'ink' : 'paper';\n      block.data.set(attribs[type], i * 4);\n    }\n\n    if (attribs.blink && attribs.ink !== attribs.paper) {\n      toBlink.push({\n        attribute: byte,\n        x: x / 8,\n        y: y / 8,\n      });\n    }\n\n    await put(ctx, block, x, y);\n\n    return;\n  }\n\n  const imageData = new Uint8ClampedArray(4 * 8); // 1x8 pixel array\n\n  for (let j = 7; j >= 0; j--) {\n    // determines bit for i, based on MSb\n    const bit = (byte & (1 << j)) === 0 ? 0 : 255;\n    imageData.set([bit, bit, bit, 255], (7 - j) * 4); // place the bits forward\n  }\n\n  // build the line based on the 8bit byte\n  // for (let j = 0; j < 8; j++) {\n  //   // determines bit for i, based on MSb\n  //   const bit = (byte & (1 << (7 - j))) === 0 ? 0 : 255;\n  //   imageData.set([bit, bit, bit, 255], j * 4);\n  // }\n\n  const x = index % 32;\n  const y = (((index >> 5) * 8) % 64) + third * 56; // this is the y coord\n  const offset = index >> 8;\n\n  // await\n  put(ctx, new ImageData(imageData, 8, 1), x * 8, y + offset);\n}\n\nexport function pixelsForSCR(buffer, ctx) {\n  const w = 256;\n  const h = 192;\n  const pixels = new Uint8ClampedArray(w * h * 4); // 196,608\n  for (let y = 0; y < h / 8; y++) {\n    for (let x = 0; x < w / 8; x++) {\n      const pixel = block(x, y, buffer); // returns 8x8\n      ctx.putImageData(new ImageData(pixel, 8, 8), x * 8, y * 8);\n    }\n  }\n\n  return pixels;\n}\n\nexport function loadBlinkAttributes(buffer, ctx) {\n  toBlink = [];\n\n  // 768\n  for (let i = 6144; i <= 6912; i++) {\n    const attribute = buffer[i];\n    const { ink, paper, blink } = readAttributes(attribute);\n    if (blink && ink.join('') !== paper.join('')) {\n      const x = i % 32;\n      const y = (i >> 5) % 64;\n\n      toBlink.push({\n        attribute,\n        i,\n        x,\n        y,\n      });\n    }\n  }\n\n  let timer = null;\n\n  const blink = {\n    start: () => {\n      timer = setInterval(() => doBlink(ctx, buffer), 333);\n    },\n    stop: () => {\n      return clearInterval(timer);\n    },\n  };\n\n  return blink;\n}\n\nasync function colour(ctx, buffer) {\n  const attribs = buffer.subarray(2048 * 3);\n\n  for (let i = 0; i < attribs.length; i++) {\n    const attribute = attribs[i];\n    const { ink, paper, blink } = readAttributes(attribute);\n\n    const x = i % (ctx.canvas.width / 8);\n    const y = (i / (ctx.canvas.width / 8)) | 0;\n\n    const pixel = new ImageData(block(x, y, buffer), 8, 8);\n\n    if (blink && ink.join('') !== paper.join('')) {\n      toBlink.push({\n        attribute,\n        x,\n        y,\n      });\n    }\n\n    await put(ctx, pixel, x * 8, y * 8); // replace the whole shebang\n  }\n}\n\nfunction doBlink(ctx, buffer) {\n  blinkOn = !blinkOn;\n\n  toBlink.forEach(item => {\n    const { x, y } = item;\n    let attribute = item.attribute;\n    if (blinkOn) {\n      // swap the paper and ink\n      attribute =\n        (attribute & 192) + // bright + blink\n        ((attribute & 7) << 3) + // ink moved to paper\n        ((attribute & 56) >> 3); // paper moved to ink\n    }\n    const pixel = new ImageData(block(x, y, buffer, attribute), 8, 8);\n    put(ctx, pixel, x * 8, y * 8);\n  });\n}\n\nexport default async function main(url) {\n  const buffer = await load(url || './screens/remy.scr');\n\n  const canvas = document.createElement('canvas');\n  const log = document.createElement('pre');\n\n  document.body.appendChild(canvas);\n  const zoom = new Zoom(buffer);\n  document.body.appendChild(log);\n  const ctx = canvas.getContext('2d');\n\n  window.ctx = ctx;\n\n  const scale = 2;\n  const w = (canvas.width = 256);\n  const h = (canvas.height = 192);\n  canvas.style.imageRendering = 'pixelated';\n  canvas.style.width = `${w * scale}px`;\n  canvas.style.height = `${h * scale}px`;\n  ctx.fillStyle = '#ccc';\n  ctx.fillRect(0, 0, w, h);\n\n  await draw(ctx, 0, buffer.subarray(0, 2048));\n  await draw(ctx, 1, buffer.subarray(2048, 2048 * 2));\n  await draw(ctx, 2, buffer.subarray(2048 * 2, 2048 * 3));\n\n  const attribs = buffer.subarray(2048 * 3);\n\n  await colour(ctx, buffer);\n  zoom.seeXY(0, 0);\n\n  // setInterval(() => zoom.seeXY(), 1000);\n\n  canvas.onmousemove = e => {\n    const { ptr, x, y, byte, bright, blink, ink, paper } = readFromPoint({\n      attribs,\n      scale,\n      x: e.pageX,\n      y: e.pageY,\n    });\n\n    zoom.seeXY(x / 8, y / 8);\n\n    log.innerHTML = `ptr: ${ptr}\nx: ${x} (${x / 8})\ny: ${y} (${y / 8})\nbyte: ${byte}\nink: <span style=\"color: white; text-shadow: 1px 1px 0 #000; background: rgb(${ink.join(\n      ','\n    )})\">${(byte & 7).toString(2).padStart(3, '0')}</span>\npaper: <span style=\"color: white; text-shadow: 1px 1px 0 #000; background: rgb(${paper.join(\n      ','\n    )})\">${((byte & 56) >> 3).toString(2).padStart(3, '0')}</span>\nbright: ${bright}\nblink: ${blink}\n`;\n  };\n\n  canvas.onclick = e => {\n    const { x, y, ink, paper } = readFromPoint({\n      attribs,\n      scale,\n      x: e.pageX,\n      y: e.pageY,\n    });\n\n    toBlink.push({\n      x,\n      y,\n      ink,\n      paper,\n    });\n  };\n\n  setInterval(() => doBlink(ctx, buffer), 333);\n}\n\nexport function blink(ctx, buffer) {\n  return setInterval(() => doBlink(ctx, buffer), 333);\n}\n\nexport function readAttributes(byte) {\n  const bright = !!(byte & 64);\n  const source = bright ? brightColours : normalColours;\n\n  const values = {\n    ink: byte & 7,\n    paper: (byte & 56) >> 3,\n  };\n\n  const ink = source[values.ink]; // 0b00000111\n  const paper = source[values.paper]; // 0b00111000\n  const blink = !!(byte & 128);\n\n  return {\n    values,\n    bright,\n    ink,\n    paper,\n    blink,\n  };\n}\n\nfunction readFromPoint({ x, y, scale = 1, attribs = [] }) {\n  x = (((x / scale) | 0) / 8) | 0;\n  y = (((y / scale) | 0) / 8) | 0;\n  const ptr = y * 32 + x;\n  const byte = attribs[ptr];\n\n  const { ink, paper, bright, blink } = readAttributes(byte);\n\n  return {\n    ptr,\n    x: x * 8,\n    y: y * 8,\n    byte,\n    ink,\n    paper,\n    blink,\n    bright,\n  };\n}\n\nfunction getIndexForXY(width, x, y) {\n  return width * y + x;\n}\n\n/**\n * Converts canvas image data to SCR binary format\n * @param {Number} third 0-2: the thirds of the screen data\n * @param {Uint8Array} arrayBuffer expected to be 3 * 2048 + 768 (empty)\n * @param {Uint8ClampedArray} canvasImageData canvas pixel data (expects to be filled)\n */\nexport function pixelsToBytes(third, arrayBuffer, canvasImageData) {\n  const data = arrayBuffer.subarray(third * 2048, (third + 1) * 2048);\n  const pixels = canvasImageData.subarray(\n    third * (canvasImageData.length / 3),\n    (third + 1) * (canvasImageData.length / 3)\n  );\n\n  let ptr = 0;\n\n  for (let offset = 0; offset < 8; offset++) {\n    for (let y = 0; y < 8; y++) {\n      const row = y * 8 + offset;\n\n      for (let x = 0; x < 32; x++) {\n        let byte = 0;\n\n        for (let j = 0; j < 8; j++) {\n          const index = getIndexForXY(256, x * 8 + j, row) * 4;\n          byte += (pixels[index] === 0 ? 1 : 0) << (7 - j);\n        }\n\n        data[ptr] = byte;\n        ptr++;\n      }\n    }\n  }\n}\n\n/**\n * Converts canvas image data to SCR binary format\n * @param {Number} third 0-2: the thirds of the screen data\n * @param {Uint8Array} allPixels expected to be 3 * 2048 + 768\n * @param {Uint8ClampedArray} allData canvas pixel data\n */\nexport function putPixels(third, allPixels, allData) {\n  const pixels = allPixels.subarray(third * 2048, (third + 1) * 2048);\n  const data = allData.subarray(\n    third * (allData.length / 3),\n    (third + 1) * (allData.length / 3)\n  );\n\n  let ptr = 0;\n\n  for (let offset = 0; offset < 8; offset++) {\n    for (let y = 0; y < 8; y++) {\n      const row = y * 8 + offset;\n\n      for (let x = 0; x < 32; x++) {\n        let bit = 0;\n\n        for (let j = 0; j < 8; j++) {\n          const index = getIndexForXY(256, x * 8 + j, row) * 4;\n          bit += (data[index] === 0 ? 1 : 0) << (7 - j);\n        }\n\n        pixels[ptr] = bit;\n        ptr++;\n      }\n    }\n  }\n}\n\nexport function getInkFromPixel(rgb, shiftBright = false) {\n  rgb = `${rgb[0]},${rgb[1]},${rgb[2]}`;\n  let ink = brightColoursLookup.get(rgb);\n\n  if (!ink) {\n    ink = normalColoursLookup.get(rgb);\n    if (shiftBright) ink <<= 3;\n  }\n\n  return ink;\n}\n\nexport function attributesForBlock(block, print) {\n  let attribute = 0;\n  const inks = new Uint8Array((0b111 << 3) + 1).fill(0); // container array\n\n  for (let i = 0; i < block.length / 4; i++) {\n    const ink = getInkFromPixel([...block.slice(i * 4, i * 4 + 3)], true);\n    inks[ink]++;\n  }\n\n  if (print) {\n    Object.keys(inks).forEach(\n      (ink, count) =>\n        inks[count] && console.log('ink %s (%s)', ink, inks[count])\n    );\n  }\n\n  let [{ ink: paper }, { ink } = { ink: 0 }] = Array.from(inks)\n    .map((count, ink) => ({ ink, count }))\n    .filter(({ count }) => count)\n    .sort((a, b) => a.count - b.count)\n    .slice(-2);\n\n  if (paper === null) {\n    paper = ink;\n  }\n\n  // this helps massage the colours into a better position\n  if (ink === 7 && paper !== 7) {\n    [ink, paper] = [paper, ink];\n  }\n\n  // work out the brightness based on the majority ink\n  if (ink >> 3 === 0 || paper >> 3 === 0) {\n    // if ink or paper is black, then take the brightness from the other colour\n    if (ink === 0 || paper === 0) {\n      const colour = ink === 0 ? paper : ink;\n      if (colour >>> 3 === 0) {\n        // colour is bright\n        attribute += 64;\n      } else {\n        // not bright\n      }\n    } else {\n      // we're dealing with bright\n      if (print) console.log('dealing with bright');\n      if (ink >> 3 === 0 && inks[ink] > inks[paper]) {\n        if (print) console.log('ink > paper', ink, paper);\n        attribute += 64;\n      } else if (paper >> 3 === 0 && inks[paper] > inks[ink]) {\n        if (print) console.log('paper > ink');\n        attribute += 64;\n      }\n    }\n  }\n\n  if (ink >> 3 !== 0) {\n    ink = ink >> 3;\n  }\n\n  if (paper >> 3 !== 0) {\n    paper = paper >> 3;\n  }\n\n  attribute += paper << 3;\n  attribute += ink;\n\n  return attribute;\n}\n\nexport function putAttributes(pixels, inkData) {\n  let ptr = 0;\n  const zoom = new Zoom(inkData);\n  for (let y = 0; y < 192 / 8; y++) {\n    for (let x = 0; x < 256 / 8; x++) {\n      const block = zoom.pixel(x, y);\n      const print = false; // x === 28 && y === 19;\n\n      pixels[2048 * 3 + ptr] = attributesForBlock(block, print);\n\n      ptr++;\n    }\n  }\n}\n\nexport function download(data, filename = 'image.png', type = 'image/png') {\n  const click = function(node) {\n    var event = new MouseEvent('click');\n    node.dispatchEvent(event);\n  };\n\n  const a = document.createElement('a');\n  a.download = filename;\n  const blob = new Blob([data], { type });\n  const url = URL.createObjectURL(blob);\n  a.href = url;\n  click(a);\n  URL.revokeObjectURL(url);\n}\n","class ArrayNode extends Array {\n  constructor() {\n    super();\n\n    // allow setting any node property via proxy\n    return new Proxy(this, {\n      set(obj, prop, value) {\n        if (prop in HTMLElement.prototype) {\n          return obj.filter(el => (el[prop] = value));\n        }\n\n        const res = (this[prop] = value);\n        return res;\n      },\n    });\n  }\n\n  on(event, handler, options) {\n    return this.filter(el => el.addEventListener(event, handler, options));\n  }\n\n  emit(type, data) {\n    const event = new Event(type, { data });\n    return this.filter(el => el.dispatchEvent(event));\n  }\n}\n\nexport const $ = (s, ctx = document) => ArrayNode.from(ctx.querySelectorAll(s));\n","export default (function() {\n  var a = document.createElement('a');\n  document.body.appendChild(a);\n  a.style = 'display: none';\n  return function(data, fileName) {\n    let blob = null;\n\n    if (data instanceof Blob) {\n      blob = data;\n    } else {\n      if (!Array.isArray(data)) {\n        data = [data];\n      }\n      blob = new Blob(data, { type: 'octet/stream' });\n    }\n    const url = URL.createObjectURL(blob);\n    a.href = url;\n    a.download = fileName;\n    a.click();\n    URL.revokeObjectURL(url);\n  };\n})();\n","export default {\n  oneDimensional: [\n    {\n      x: 1,\n      y: 0,\n      factor: 1,\n    },\n  ],\n  floydSteinberg: [\n    {\n      x: 1,\n      y: 0,\n      factor: 7 / 16,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 3 / 16,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 5 / 16,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 1 / 16,\n    },\n  ],\n  jarvisJudiceNinke: [\n    {\n      x: 1,\n      y: 0,\n      factor: 7 / 48,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 5 / 48,\n    },\n    {\n      x: -2,\n      y: 1,\n      factor: 3 / 48,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 5 / 48,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 7 / 48,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 5 / 48,\n    },\n    {\n      x: 2,\n      y: 1,\n      factor: 3 / 48,\n    },\n    {\n      x: -2,\n      y: 2,\n      factor: 1 / 48,\n    },\n    {\n      x: -1,\n      y: 2,\n      factor: 3 / 48,\n    },\n    {\n      x: 0,\n      y: 2,\n      factor: 5 / 48,\n    },\n    {\n      x: 1,\n      y: 2,\n      factor: 3 / 48,\n    },\n    {\n      x: 2,\n      y: 2,\n      factor: 1 / 48,\n    },\n  ],\n  stucki: [\n    {\n      x: 1,\n      y: 0,\n      factor: 8 / 42,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 4 / 42,\n    },\n    {\n      x: -2,\n      y: 1,\n      factor: 2 / 42,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 4 / 42,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 8 / 42,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 4 / 42,\n    },\n    {\n      x: 2,\n      y: 1,\n      factor: 2 / 42,\n    },\n    {\n      x: -2,\n      y: 2,\n      factor: 1 / 42,\n    },\n    {\n      x: -1,\n      y: 2,\n      factor: 2 / 42,\n    },\n    {\n      x: 0,\n      y: 2,\n      factor: 4 / 42,\n    },\n    {\n      x: 1,\n      y: 2,\n      factor: 2 / 42,\n    },\n    {\n      x: 2,\n      y: 2,\n      factor: 1 / 42,\n    },\n  ],\n  atkinson: [\n    {\n      x: 1,\n      y: 0,\n      factor: 1 / 8,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 1 / 8,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 1 / 8,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 1 / 8,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 1 / 8,\n    },\n    {\n      x: 0,\n      y: 2,\n      factor: 1 / 8,\n    },\n  ],\n  burkes: [\n    {\n      x: 1,\n      y: 0,\n      factor: 8 / 32,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 4 / 32,\n    },\n    {\n      x: -2,\n      y: 1,\n      factor: 2 / 32,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 4 / 32,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 8 / 32,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 4 / 32,\n    },\n    {\n      x: 2,\n      y: 1,\n      factor: 2 / 32,\n    },\n  ],\n  sierra3: [\n    {\n      x: 1,\n      y: 0,\n      factor: 5 / 32,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 3 / 32,\n    },\n    {\n      x: -2,\n      y: 1,\n      factor: 2 / 32,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 4 / 32,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 5 / 32,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 4 / 32,\n    },\n    {\n      x: 2,\n      y: 1,\n      factor: 2 / 32,\n    },\n    {\n      x: -1,\n      y: 2,\n      factor: 2 / 32,\n    },\n    {\n      x: 0,\n      y: 2,\n      factor: 3 / 32,\n    },\n    {\n      x: 1,\n      y: 2,\n      factor: 2 / 32,\n    },\n  ],\n  sierra2: [\n    {\n      x: 1,\n      y: 0,\n      factor: 4 / 16,\n    },\n    {\n      x: 2,\n      y: 0,\n      factor: 3 / 16,\n    },\n    {\n      x: -2,\n      y: 1,\n      factor: 1 / 16,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 2 / 16,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 3 / 16,\n    },\n    {\n      x: 1,\n      y: 1,\n      factor: 2 / 16,\n    },\n    {\n      x: 2,\n      y: 1,\n      factor: 1 / 16,\n    },\n  ],\n  sierraLite: [\n    {\n      x: 1,\n      y: 0,\n      factor: 2 / 4,\n    },\n    {\n      x: -1,\n      y: 1,\n      factor: 1 / 4,\n    },\n    {\n      x: 0,\n      y: 1,\n      factor: 1 / 4,\n    },\n  ],\n  none: [],\n};\n","import matrices from './matrices.js';\n\nconst colorMap = [\n  [0, 0, 0xff],\n  [0xff, 0, 0],\n  [0xff, 0, 0xff],\n  [0, 0xff, 0],\n  [0, 0xff, 0xff],\n  [0xff, 0xff, 0],\n  [0xff, 0xff, 0xff],\n  [0, 0, 0],\n  [0, 0, 0xd7],\n  [0xd7, 0, 0],\n  [0xd7, 0, 0xd7],\n  [0, 0xd7, 0],\n  [0, 0xd7, 0xd7],\n  [0xd7, 0xd7, 0],\n  [0xd7, 0xd7, 0xd7],\n];\n\nfunction getDistance(current, match) {\n  const redDifference = current[0] - match[0];\n  const greenDifference = current[1] - match[1];\n  const blueDifference = current[2] - match[2];\n\n  return (\n    redDifference * redDifference +\n    greenDifference * greenDifference +\n    blueDifference * blueDifference\n  );\n}\n\n// feels expensive, but https://www.cyotek.com/blog/finding-nearest-colors-using-euclidean-distance\nfunction defaultFindColor(rgb) {\n  let shortestDistance;\n  let index;\n\n  index = -1;\n  shortestDistance = Number.MAX_SAFE_INTEGER;\n\n  for (let i = 0; i < colorMap.length; i++) {\n    const match = colorMap[i];\n    const distance = getDistance(rgb, match);\n\n    if (distance < shortestDistance) {\n      index = i;\n      shortestDistance = distance;\n    }\n  }\n\n  return [...colorMap[index], 255];\n}\n\nconst defaults = {\n  step: 4,\n  channels: 4,\n  diffusionFactor: 0.9,\n  clip: () => {},\n  findColor: defaultFindColor,\n  matrix: matrices.floydSteinberg,\n};\n\nexport default class Dither {\n  constructor(options) {\n    this.options = { ...defaults, ...options };\n  }\n\n  static get defaultFindColor() {\n    return defaultFindColor;\n  }\n\n  static get matrices() {\n    return matrices;\n  }\n\n  dither(buffer, width, settings = {}) {\n    let i, k, ref, x, y;\n    const options = { ...this.options, ...settings };\n\n    const d = [];\n    for (\n      i = k = 0, ref = buffer.length;\n      0 <= ref ? k <= ref : k >= ref;\n      i = 0 <= ref ? ++k : --k\n    ) {\n      d.push(buffer[i]);\n    }\n    const height = buffer.length / (options.channels * width);\n    const result = [];\n    y = 0;\n    while (y < height) {\n      x = 0;\n      while (x < width) {\n        this.handlePixel(x, y, d, result, width, options);\n        x += options.step;\n      }\n      y += options.step;\n    }\n    return result;\n  }\n\n  calculateIndex(x, y, width, channels) {\n    return channels * x + channels * y * width;\n  }\n\n  handlePixel(x, y, d, result, width, options) {\n    var currentColor, i, j, k, l, newColor, q, ref, ref1;\n    i = this.calculateIndex(x, y, width, options.channels);\n    currentColor = [];\n    for (\n      j = k = 0, ref = options.channels;\n      0 <= ref ? k < ref : k > ref;\n      j = 0 <= ref ? ++k : --k\n    ) {\n      currentColor.push(d[i + j]);\n    }\n    newColor = options.findColor(currentColor);\n    q = [];\n    for (\n      j = l = 0, ref1 = options.channels;\n      0 <= ref1 ? l < ref1 : l > ref1;\n      j = 0 <= ref1 ? ++l : --l\n    ) {\n      q[j] = (d[i + j] - newColor[j]) * options.diffusionFactor;\n    }\n    this.diffuseError(d, q, x, y, width, options);\n    return this.applyNewColor(result, width, newColor, i, options);\n  }\n\n  diffuseError(d, q, x, y, width, options) {\n    var channelOffset, entry, index, k, l, len, ref, ref1, results;\n    ref = options.matrix;\n    results = [];\n    for (k = 0, len = ref.length; k < len; k++) {\n      entry = ref[k];\n      index = this.calculateIndex(\n        x + options.step * entry.x,\n        y + options.step * entry.y,\n        width,\n        options.channels\n      );\n      for (\n        channelOffset = l = 0, ref1 = options.channels;\n        0 <= ref1 ? l < ref1 : l > ref1;\n        channelOffset = 0 <= ref1 ? ++l : --l\n      ) {\n        d[index + channelOffset] += entry.factor * q[channelOffset];\n      }\n      results.push(options.clip(d, index));\n    }\n    return results;\n  }\n\n  applyNewColor(buffer, width, newColor, i, options) {\n    var di, dx, dy, j, k, ref, results;\n    results = [];\n    for (\n      dx = k = 0, ref = options.step;\n      0 <= ref ? k < ref : k > ref;\n      dx = 0 <= ref ? ++k : --k\n    ) {\n      results.push(\n        (function() {\n          var l, ref1, results1;\n          results1 = [];\n          for (\n            dy = l = 0, ref1 = options.step;\n            0 <= ref1 ? l < ref1 : l > ref1;\n            dy = 0 <= ref1 ? ++l : --l\n          ) {\n            di = i + options.channels * dx + options.channels * width * dy;\n            results1.push(\n              (function() {\n                var m, ref2, results2;\n                results2 = [];\n                for (\n                  j = m = 0, ref2 = options.channels;\n                  0 <= ref2 ? m < ref2 : m > ref2;\n                  j = 0 <= ref2 ? ++m : --m\n                ) {\n                  results2.push((buffer[di + j] = newColor[j]));\n                }\n                return results2;\n              })()\n            );\n          }\n          return results1;\n        })()\n      );\n    }\n    return results;\n  }\n}\n","import Zoom from './Zoom.js';\n\nexport default function main(image) {\n  return imageToBlob(image).then(fileToBinary);\n}\n\nexport function contrast(imageData, contrast = 50) {\n  const data = imageData.data;\n  contrast = contrast / 100 + 1; //convert to decimal & shift range: [0..2]\n  const intercept = 128 * (1 - contrast);\n  for (let i = 0; i < data.length; i += 4) {\n    data[i] = data[i] * contrast + intercept;\n    data[i + 1] = data[i + 1] * contrast + intercept;\n    data[i + 2] = data[i + 2] * contrast + intercept;\n  }\n  return imageData;\n}\n\nexport function threshold(data, _, threshold = _) {\n  for (let i = 0; i < data.length; i += 4) {\n    const r = data[i];\n    const g = data[i + 1];\n    const b = data[i + 2];\n\n    const test = 0.2126 * r + 0.7152 * g + 0.0722 * b;\n\n    const v = test >= threshold ? 255 : 0;\n    data[i] = data[i + 1] = data[i + 2] = v;\n  }\n\n  invertPotentialInk(data);\n\n  return data;\n}\n\nexport function invertPotentialInk(imageData) {\n  const zoom = new Zoom(imageData);\n  for (let y = 0; y < 192 / 8; y++) {\n    for (let x = 0; x < 256 / 8; x++) {\n      const block = zoom.pixel(x, y);\n\n      let inkCount = 0;\n      for (let i = 0; i < 8 * 8 * 4; i += 4) {\n        if (block[i] === 0) {\n          // black = ink\n          inkCount = inkCount + 1;\n        }\n      }\n\n      if (inkCount < 32) {\n        // flip\n        for (let i = 0; i < 8 * 8 * 4; i += 4) {\n          const c = block[i] === 0 ? 255 : 0;\n          block[i] = block[i + 1] = block[i + 2] = c;\n        }\n      }\n    }\n  }\n  return imageData;\n}\n\nfunction crop(\n  source = { width: 0, height: 0 },\n  destination = { width: 0, height: 0 }\n) {\n  // result:\n  let x = 0;\n  let y = 0;\n\n  // which is longest side\n  let longest = 'width';\n  let shortest = 'height';\n  if (destination.width < destination.height) {\n    [longest, shortest] = [shortest, longest];\n  }\n\n  // get divisor\n  const d = source[longest] / destination[longest]; // FIXME does this work for scaling up?\n\n  const width = (destination.width * d) | 0;\n  const height = (destination.height * d) | 0;\n\n  if (longest === 'height') {\n    x = (source[shortest] - width) / 2;\n  } else {\n    y = (source[shortest] - height) / 2;\n  }\n\n  return { x, y, width, height };\n}\n\nexport function imageToCanvas(\n  img,\n  scale = { width: img.width, height: img.height }\n) {\n  const canvas = document.createElement('canvas');\n  canvas.style.imageRendering = 'pixelated';\n  const ctx = canvas.getContext('2d');\n  canvas.width = scale.width;\n  canvas.height = scale.height;\n\n  const { x, y, height, width } = crop(img, canvas);\n\n  ctx.drawImage(img, x, y, width, height, 0, 0, canvas.width, canvas.height);\n\n  return ctx;\n}\n\nexport function imageToPixels(img, scale) {\n  const ctx = imageToCanvas(img, scale);\n  return ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);\n}\n\nexport async function imageToBlob(img, ctx = imageToCanvas(img)) {\n  return new Promise(resolve => {\n    const canvas = ctx.canvas;\n    canvas.toBlob(file => resolve(file));\n  });\n}\n\nexport function fileToBinary(file) {\n  return new Promise(resolve => {\n    const reader = new window.FileReader();\n    reader.onloadend = () => resolve(new Uint8Array(reader.result));\n    reader.readAsArrayBuffer(file);\n  });\n}\n","import Dither from './Dither.js';\nimport Zoom from './Zoom.js';\nimport { imageToCanvas, contrast } from './image.js';\nimport {\n  attributesForBlock,\n  readAttributes,\n  pixelsForSCR,\n  putAttributes,\n  getInkFromPixel,\n  putPixels,\n} from './scr.js';\n\nexport async function dither({ url, all = false, debug = false }) {\n  const img = new Image();\n  img.crossOrigin = 'anonymous';\n  img.src = url;\n  await new Promise((resolve, reject) => {\n    img.onload = resolve;\n    img.onerror = reject;\n  });\n  if (debug) document.body.appendChild(img);\n  const ctx = imageToCanvas(img, { width: 256, height: 192 });\n  const canvas = ctx.canvas;\n  const w = canvas.width;\n  const h = canvas.height;\n\n  if (debug) document.body.appendChild(canvas);\n\n  // the buffer is used to draw into as a temp space\n  const bufferCtx = document.createElement('canvas').getContext('2d');\n  bufferCtx.canvas.width = w;\n  bufferCtx.canvas.height = h;\n\n  if (debug) document.body.appendChild(bufferCtx.canvas);\n\n  const dither = new Dither({\n    matrix: Dither.matrices.none,\n    step: 1,\n  });\n\n  const { imageData: inkData } = await render(ctx, bufferCtx, dither, {\n    diffusionFactor: 0.1,\n    matrix: Dither.matrices.atkinson,\n  });\n\n  const { imageData: pixelData } = await renderFromInk(bufferCtx, bufferCtx);\n\n  // load all the final output into SCR format - starting with binary for pixels\n  const pixels = new Uint8Array((256 * 192) / 8 + 768);\n  putPixels(0, pixels, pixelData.data);\n  putPixels(1, pixels, pixelData.data);\n  putPixels(2, pixels, pixelData.data);\n\n  // …then try to work out the attributes (bright, ink and paper)\n  putAttributes(pixels, inkData);\n\n  if (all) {\n    return {\n      pixels,\n      inkData,\n      pixelData,\n      originalData: ctx.getImageData(0, 0, w, h),\n    };\n  }\n\n  return pixels; // this is the raw binary .src format\n}\n\nasync function pixelsToImage(pixels) {\n  const ctx = document.createElement('canvas').getContext('2d');\n  const canvas = ctx.canvas;\n  canvas.width = 256;\n  canvas.height = 192;\n\n  ctx.putImageData(pixels, 0, 0);\n\n  const url = canvas.toDataURL('image/png');\n  const img = new Image();\n  img.src = url;\n  return new Promise(resolve => (img.onload = () => resolve(img)));\n}\n\nexport default async function main(\n  url = `https://twivatar.glitch.me/${prompt('Give me a twitter handle:')}`\n) {\n  // export default async function main(url = './image-manip/tap-js.png') {\n  // const username = prompt('Give me a twitter handle:');\n\n  // ctx = drawing context with our source image\n  const { pixels, inkData, pixelData, originalData } = await dither(\n    // `https://twivatar.glitch.me/${username}`,\n    url,\n    true\n  );\n\n  const scrBlob = new Blob([pixels], {\n    'content-type': 'application/binary',\n  });\n  const scrURL = URL.createObjectURL(scrBlob);\n\n  const container = document.createElement('div');\n  document.body.appendChild(container);\n\n  const scrCtx = document.createElement('canvas').getContext('2d');\n  scrCtx.canvas.width = 256;\n  scrCtx.canvas.height = 192;\n  container.appendChild(scrCtx.canvas);\n  // validate our pixels by translating the SCR binary back into a canvas\n  pixelsForSCR(pixels, scrCtx);\n\n  const ul = document.createElement('ul');\n  ul.innerHTML = `<li><a href=\"${scrURL}\" download=\"image.scr\">Download .SCR file</a></li>`;\n\n  const li = document.createElement('li');\n  ul.appendChild(li);\n  const attribsLI = document.createElement('li');\n  ul.appendChild(attribsLI);\n  document.body.appendChild(ul);\n\n  // put all the image data into imgs\n  const img2 = await pixelsToImage(originalData);\n  container.appendChild(img2);\n  const inkImg = await pixelsToImage(inkData);\n  container.appendChild(inkImg);\n  const pixelImg = await pixelsToImage(pixelData);\n  container.appendChild(pixelImg);\n\n  const zoomOriginal = new Zoom(img2);\n  const zoomPixel = new Zoom(pixelImg);\n  const zoomInk = new Zoom(inkImg);\n  const zoomResult = new Zoom(scrCtx);\n\n  const rootCanvas = document.querySelector('canvas');\n  rootCanvas.classList.add('crosshair');\n\n  let hover = true;\n\n  rootCanvas.onclick = () => {\n    hover = !hover;\n  };\n\n  rootCanvas.onmousemove = e => {\n    if (!hover) return;\n    const x = (e.pageX / 8) | 0;\n    const y = (e.pageY / 8) | 0;\n    zoomResult.seeXY(x, y);\n    zoomOriginal.seeXY(x, y);\n    zoomInk.seeXY(x, y);\n    zoomPixel.seeXY(x, y);\n    li.innerHTML = `{ x: ${x}, y: ${y} }`;\n    const block = zoomInk.pixel(x, y);\n    const byte = attributesForBlock(block);\n    window.attributesForBlock = attributesForBlock.bind(null, block);\n    const debug = y === 18 && x === 20;\n    const attribs = readAttributes(byte, debug);\n    const ink = attribs.ink.join(',');\n    const paper = attribs.paper.join(',');\n    attribsLI.innerHTML = `ink: ${ink} (${attribs.values.ink}) <span class=\"block\" style=\"background: rgb(${ink})\"></span>, paper: ${paper} (${attribs.values.paper}) <span class=\"block\" style=\"background: rgb(${paper})\"></span>`;\n  };\n}\n\nasync function render(ctx, bufferCtx, dither, options = {}) {\n  const w = ctx.canvas.width;\n  const h = ctx.canvas.height;\n  const buffer = contrast(ctx.getImageData(0, 0, w, h), 10);\n  const res = dither.dither(buffer.data, w, options);\n  const imageData = new ImageData(new Uint8ClampedArray(res), w, h);\n  bufferCtx.putImageData(imageData, 0, 0);\n\n  return { imageData };\n}\n\nfunction putInkForBlock(\n  zoom,\n  x,\n  y,\n  newBlock = new Uint8ClampedArray(8 * 8 * 4)\n) {\n  const block = zoom.pixel(x, y);\n  // 1: find how many colours we're dealing with (256 elements)\n  // 2: if 2 - switch them to majority paper (0b0) and least ink (0b1)\n  // 3: if more than two, order then select\n  const print = x === 3 && y === 1;\n  const byte = attributesForBlock(block, print);\n  const attributes = readAttributes(byte);\n\n  if (print) console.log(attributes);\n\n  for (let i = 0; i < 64; i++) {\n    const ink = getInkFromPixel([...block.slice(i * 4, i * 4 + 3)]);\n\n    if (ink === attributes.values.ink) {\n      newBlock.set([0, 0, 0, 255], i * 4);\n    } else if (ink === attributes.values.paper) {\n      newBlock.set([255, 255, 255, 255], i * 4);\n    } else {\n      newBlock.set([0, 0, 0, 255], i * 4);\n    }\n  }\n\n  return newBlock;\n}\n\nasync function renderFromInk(ctx, bufferCtx) {\n  const w = ctx.canvas.width;\n  const h = ctx.canvas.height;\n  const buffer = ctx.getImageData(0, 0, w, h);\n\n  const zoom = new Zoom(buffer.data);\n\n  const blockBuffer = new Uint8ClampedArray(8 * 8 * 4);\n\n  for (let y = 0; y < 192 / 8; y++) {\n    for (let x = 0; x < 256 / 8; x++) {\n      putInkForBlock(zoom, x, y, blockBuffer);\n\n      bufferCtx.putImageData(new ImageData(blockBuffer, 8, 8), x * 8, y * 8);\n    }\n  }\n\n  const imageData = bufferCtx.getImageData(0, 0, w, h);\n\n  return { imageData };\n}\n\nif (window.location.search.includes('retrofy')) main();\n","import drop from '../lib/dnd.js';\nimport { pixelsForSCR } from './lib/scr.js';\nimport { $ } from '../lib/$.js';\nimport save from '../lib/save.js';\nimport { dither } from './lib/retrofy.js';\n\nconst result = $('#result')[0];\n\nfunction basename(filename) {\n  return filename\n    .split('.')\n    .slice(0, -1)\n    .join('.');\n}\n\nfunction container(filename, altDownload) {\n  const isSCR = filename.toUpperCase().endsWith('.SCR');\n\n  const canvas = document.createElement('canvas');\n  canvas.width = 256;\n  canvas.height = 192;\n  const ctx = canvas.getContext('2d');\n  const div = document.createElement('div');\n  div.className = 'container';\n  div.appendChild(canvas);\n\n  const button = document.createElement('button');\n  div.appendChild(button);\n  button.onclick = async () => {\n    const file = await new Promise(resolve => canvas.toBlob(resolve));\n\n    save(file, basename(filename) + '.png');\n  };\n  button.innerText = 'Download PNG';\n\n  if (!isSCR) {\n    const button = document.createElement('button');\n    div.appendChild(button);\n    button.onclick = async () => {\n      save(altDownload, basename(filename) + '.scr');\n    };\n    button.innerText = 'Download SCR';\n  }\n\n  result.prepend(div);\n  return ctx;\n}\n\nasync function fileHandler(data, filename, type) {\n  if (filename.toUpperCase().endsWith('.SCR')) {\n    pixelsForSCR(data, container(filename));\n  } else {\n    const blob = new Blob([data], { type });\n    const url = URL.createObjectURL(blob);\n    const res = await dither({ url });\n    console.log(res);\n    pixelsForSCR(res, container(filename, res));\n    URL.revokeObjectURL(url);\n  }\n}\n\ndrop(document.body, fileHandler);\n\n$('input').on('change', event => {\n  const file = event.target.files[0];\n  const reader = new FileReader();\n  reader.onload = event =>\n    fileHandler(new Uint8Array(event.target.result), file.name, file.type);\n  reader.readAsArrayBuffer(file);\n});\n","var OVERLAY_ID = '__parcel__error__overlay__';\n\nvar OldModule = module.bundle.Module;\n\nfunction Module(moduleName) {\n  OldModule.call(this, moduleName);\n  this.hot = {\n    data: module.bundle.hotData,\n    _acceptCallbacks: [],\n    _disposeCallbacks: [],\n    accept: function (fn) {\n      this._acceptCallbacks.push(fn || function () {});\n    },\n    dispose: function (fn) {\n      this._disposeCallbacks.push(fn);\n    }\n  };\n\n  module.bundle.hotData = null;\n}\n\nmodule.bundle.Module = Module;\nvar checkedAssets, assetsToAccept;\n\nvar parent = module.bundle.parent;\nif ((!parent || !parent.isParcelRequire) && typeof WebSocket !== 'undefined') {\n  var hostname = process.env.HMR_HOSTNAME || location.hostname;\n  var protocol = location.protocol === 'https:' ? 'wss' : 'ws';\n  var ws = new WebSocket(protocol + '://' + hostname + ':' + process.env.HMR_PORT + '/');\n  ws.onmessage = function(event) {\n    checkedAssets = {};\n    assetsToAccept = [];\n\n    var data = JSON.parse(event.data);\n\n    if (data.type === 'update') {\n      var handled = false;\n      data.assets.forEach(function(asset) {\n        if (!asset.isNew) {\n          var didAccept = hmrAcceptCheck(global.parcelRequire, asset.id);\n          if (didAccept) {\n            handled = true;\n          }\n        }\n      });\n\n      // Enable HMR for CSS by default.\n      handled = handled || data.assets.every(function(asset) {\n        return asset.type === 'css' && asset.generated.js;\n      });\n\n      if (handled) {\n        console.clear();\n\n        data.assets.forEach(function (asset) {\n          hmrApply(global.parcelRequire, asset);\n        });\n\n        assetsToAccept.forEach(function (v) {\n          hmrAcceptRun(v[0], v[1]);\n        });\n      } else if (location.reload) { // `location` global exists in a web worker context but lacks `.reload()` function.\n        location.reload();\n      }\n    }\n\n    if (data.type === 'reload') {\n      ws.close();\n      ws.onclose = function () {\n        location.reload();\n      }\n    }\n\n    if (data.type === 'error-resolved') {\n      console.log('[parcel] ✨ Error resolved');\n\n      removeErrorOverlay();\n    }\n\n    if (data.type === 'error') {\n      console.error('[parcel] 🚨  ' + data.error.message + '\\n' + data.error.stack);\n\n      removeErrorOverlay();\n\n      var overlay = createErrorOverlay(data);\n      document.body.appendChild(overlay);\n    }\n  };\n}\n\nfunction removeErrorOverlay() {\n  var overlay = document.getElementById(OVERLAY_ID);\n  if (overlay) {\n    overlay.remove();\n  }\n}\n\nfunction createErrorOverlay(data) {\n  var overlay = document.createElement('div');\n  overlay.id = OVERLAY_ID;\n\n  // html encode message and stack trace\n  var message = document.createElement('div');\n  var stackTrace = document.createElement('pre');\n  message.innerText = data.error.message;\n  stackTrace.innerText = data.error.stack;\n\n  overlay.innerHTML = (\n    '<div style=\"background: black; font-size: 16px; color: white; position: fixed; height: 100%; width: 100%; top: 0px; left: 0px; padding: 30px; opacity: 0.85; font-family: Menlo, Consolas, monospace; z-index: 9999;\">' +\n      '<span style=\"background: red; padding: 2px 4px; border-radius: 2px;\">ERROR</span>' +\n      '<span style=\"top: 2px; margin-left: 5px; position: relative;\">🚨</span>' +\n      '<div style=\"font-size: 18px; font-weight: bold; margin-top: 20px;\">' + message.innerHTML + '</div>' +\n      '<pre>' + stackTrace.innerHTML + '</pre>' +\n    '</div>'\n  );\n\n  return overlay;\n\n}\n\nfunction getParents(bundle, id) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return [];\n  }\n\n  var parents = [];\n  var k, d, dep;\n\n  for (k in modules) {\n    for (d in modules[k][1]) {\n      dep = modules[k][1][d];\n      if (dep === id || (Array.isArray(dep) && dep[dep.length - 1] === id)) {\n        parents.push(k);\n      }\n    }\n  }\n\n  if (bundle.parent) {\n    parents = parents.concat(getParents(bundle.parent, id));\n  }\n\n  return parents;\n}\n\nfunction hmrApply(bundle, asset) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return;\n  }\n\n  if (modules[asset.id] || !bundle.parent) {\n    var fn = new Function('require', 'module', 'exports', asset.generated.js);\n    asset.isNew = !modules[asset.id];\n    modules[asset.id] = [fn, asset.deps];\n  } else if (bundle.parent) {\n    hmrApply(bundle.parent, asset);\n  }\n}\n\nfunction hmrAcceptCheck(bundle, id) {\n  var modules = bundle.modules;\n  if (!modules) {\n    return;\n  }\n\n  if (!modules[id] && bundle.parent) {\n    return hmrAcceptCheck(bundle.parent, id);\n  }\n\n  if (checkedAssets[id]) {\n    return;\n  }\n  checkedAssets[id] = true;\n\n  var cached = bundle.cache[id];\n\n  assetsToAccept.push([bundle, id]);\n\n  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {\n    return true;\n  }\n\n  return getParents(global.parcelRequire, id).some(function (id) {\n    return hmrAcceptCheck(global.parcelRequire, id)\n  });\n}\n\nfunction hmrAcceptRun(bundle, id) {\n  var cached = bundle.cache[id];\n  bundle.hotData = {};\n  if (cached) {\n    cached.hot.data = bundle.hotData;\n  }\n\n  if (cached && cached.hot && cached.hot._disposeCallbacks.length) {\n    cached.hot._disposeCallbacks.forEach(function (cb) {\n      cb(bundle.hotData);\n    });\n  }\n\n  delete bundle.cache[id];\n  bundle(id);\n\n  cached = bundle.cache[id];\n  if (cached && cached.hot && cached.hot._acceptCallbacks.length) {\n    cached.hot._acceptCallbacks.forEach(function (cb) {\n      cb();\n    });\n    return true;\n  }\n}\n"]}